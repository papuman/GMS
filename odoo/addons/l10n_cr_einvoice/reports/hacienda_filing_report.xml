<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Monthly Hacienda Filing Report Template -->
    <template id="report_hacienda_filing">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <h2>Reporte Mensual para Declaración Hacienda</h2>
                    <h3><span t-esc="data['month_name']"/> <span t-esc="data['year']"/></h3>

                    <div class="row mt32 mb16">
                        <div class="col-12">
                            <h4>Resumen de Documentos</h4>
                            <table class="table table-sm table-bordered">
                                <tr>
                                    <td><strong>Facturas Electrónicas (FE):</strong></td>
                                    <td class="text-right"><span t-esc="data['fe_count']"/></td>
                                </tr>
                                <tr>
                                    <td><strong>Tiquetes Electrónicos (TE):</strong></td>
                                    <td class="text-right"><span t-esc="data['te_count']"/></td>
                                </tr>
                                <tr>
                                    <td><strong>Notas de Crédito (NC):</strong></td>
                                    <td class="text-right"><span t-esc="data['nc_count']"/></td>
                                </tr>
                                <tr>
                                    <td><strong>Notas de Débito (ND):</strong></td>
                                    <td class="text-right"><span t-esc="data['nd_count']"/></td>
                                </tr>
                                <tr class="table-secondary">
                                    <td><strong>TOTAL DOCUMENTOS:</strong></td>
                                    <td class="text-right"><strong><span t-esc="data['total_documents']"/></strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="row mt32 mb16">
                        <div class="col-12">
                            <h4>Resumen Financiero</h4>
                            <table class="table table-sm table-bordered">
                                <tr>
                                    <td><strong>Ventas Brutas (FE + TE):</strong></td>
                                    <td class="text-right">₡<span t-esc="'{:,.2f}'.format(data['total_sales'])"/></td>
                                </tr>
                                <tr>
                                    <td><strong>Notas de Crédito:</strong></td>
                                    <td class="text-right">(₡<span t-esc="'{:,.2f}'.format(data['total_credits'])"/>)</td>
                                </tr>
                                <tr>
                                    <td><strong>Notas de Débito:</strong></td>
                                    <td class="text-right">₡<span t-esc="'{:,.2f}'.format(data['total_debits'])"/></td>
                                </tr>
                                <tr class="table-success">
                                    <td><strong>VENTAS NETAS:</strong></td>
                                    <td class="text-right"><strong>₡<span t-esc="'{:,.2f}'.format(data['net_sales'])"/></strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="row mt32 mb16">
                        <div class="col-12">
                            <h4>Resumen de Impuestos</h4>
                            <table class="table table-sm table-bordered">
                                <tr>
                                    <td><strong>Impuesto Total:</strong></td>
                                    <td class="text-right">₡<span t-esc="'{:,.2f}'.format(data['total_tax'])"/></td>
                                </tr>
                                <tr>
                                    <td><strong>Impuesto en NC:</strong></td>
                                    <td class="text-right">(₡<span t-esc="'{:,.2f}'.format(data['credit_tax'])"/>)</td>
                                </tr>
                                <tr class="table-warning">
                                    <td><strong>IMPUESTO NETO A DECLARAR:</strong></td>
                                    <td class="text-right"><strong>₡<span t-esc="'{:,.2f}'.format(data['net_tax'])"/></strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="row mt32 mb16">
                        <div class="col-12">
                            <h4>Detalle de Impuestos por Tasa</h4>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr class="table-primary">
                                        <th>Tasa</th>
                                        <th>Nombre</th>
                                        <th class="text-right">Base Imponible</th>
                                        <th class="text-right">Impuesto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="data['tax_by_rate']" t-as="item">
                                        <td><span t-esc="'{:.2f}%'.format(item['rate'])"/></td>
                                        <td><span t-esc="item['name']"/></td>
                                        <td class="text-right">₡<span t-esc="'{:,.2f}'.format(item['base'])"/></td>
                                        <td class="text-right">₡<span t-esc="'{:,.2f}'.format(item['tax'])"/></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row mt32 mb16">
                        <div class="col-12">
                            <h4>Top 20 Clientes del Mes</h4>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr class="table-primary">
                                        <th>Cliente</th>
                                        <th>Identificación</th>
                                        <th class="text-right">Facturas</th>
                                        <th class="text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="data['top_customers']" t-as="customer">
                                        <td><span t-esc="customer['partner_name']"/></td>
                                        <td><span t-esc="customer['partner_vat']"/></td>
                                        <td class="text-right"><span t-esc="customer['invoice_count']"/></td>
                                        <td class="text-right">₡<span t-esc="'{:,.2f}'.format(customer['total_amount'])"/></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row mt32">
                        <div class="col-12">
                            <p class="text-muted">Reporte generado el <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%Y-%m-%d %H:%M:%S')"/></p>
                            <p class="text-muted"><strong>Nota:</strong> Este reporte contiene únicamente documentos aceptados por Hacienda en el período indicado.</p>
                        </div>
                    </div>
                </div>
            </t>
        </t>
    </template>

    <!-- Report Action -->
    <record id="action_report_hacienda_filing" model="ir.actions.report">
        <field name="name">Declaración Mensual Hacienda</field>
        <field name="model">l10n_cr.einvoice.document</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">l10n_cr_einvoice.report_hacienda_filing</field>
        <field name="report_file">l10n_cr_einvoice.report_hacienda_filing</field>
        <field name="binding_model_id" ref="model_l10n_cr_einvoice_document"/>
        <field name="binding_type">report</field>
    </record>
</odoo>

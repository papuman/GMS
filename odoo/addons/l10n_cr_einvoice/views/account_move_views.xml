<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit Invoice Form View to Add E-Invoice Integration -->
    <record id="view_move_form_einvoice" model="ir.ui.view">
        <field name="name">account.move.form.einvoice</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">

            <!-- Add E-Invoice Status Button to Button Box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_create_einvoice"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-file-code-o"
                        invisible="not l10n_cr_requires_einvoice or l10n_cr_einvoice_id"
                        context="{'default_move_id': id}">
                    <span class="o_stat_text">Create</span>
                    <span class="o_stat_text">E-Invoice</span>
                </button>

                <button name="action_create_einvoice"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-file-code-o"
                        invisible="not l10n_cr_einvoice_id"
                        context="{'default_move_id': id}">
                    <span class="o_stat_value">
                        <field name="l10n_cr_einvoice_state"
                               widget="badge"
                               decoration-muted="l10n_cr_einvoice_state == 'draft'"
                               decoration-info="l10n_cr_einvoice_state == 'generated'"
                               decoration-primary="l10n_cr_einvoice_state == 'signed'"
                               decoration-warning="l10n_cr_einvoice_state == 'submitted'"
                               decoration-success="l10n_cr_einvoice_state == 'accepted'"
                               decoration-danger="l10n_cr_einvoice_state in ('rejected', 'error')"/>
                    </span>
                    <span class="o_stat_text">E-Invoice</span>
                </button>
            </xpath>

            <!-- Add E-Invoice Action Buttons in Header -->
            <xpath expr="//header" position="inside">
                <button name="action_generate_and_send_einvoice"
                        string="Generate &amp; Send E-Invoice"
                        type="object"
                        class="oe_highlight"
                        invisible="not l10n_cr_requires_einvoice or l10n_cr_einvoice_state == 'accepted'"
                        confirm="This will generate the electronic invoice, sign it, submit to Hacienda and send email. Continue?"/>
            </xpath>

        </field>
    </record>

    <!-- Inherit Invoice Tree View to Show E-Invoice Status -->
    <record id="view_move_tree_einvoice" model="ir.ui.view">
        <field name="name">account.move.tree.einvoice</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_invoice_tree"/>
        <field name="arch" type="xml">
            <!-- Add E-Invoice Status Column -->
            <xpath expr="//field[@name='payment_state']" position="after">
                <field name="l10n_cr_einvoice_state"
                       string="E-Invoice"
                       optional="show"
                       widget="badge"
                       decoration-muted="l10n_cr_einvoice_state == 'draft'"
                       decoration-info="l10n_cr_einvoice_state == 'generated'"
                       decoration-primary="l10n_cr_einvoice_state == 'signed'"
                       decoration-warning="l10n_cr_einvoice_state == 'submitted'"
                       decoration-success="l10n_cr_einvoice_state == 'accepted'"
                       decoration-danger="l10n_cr_einvoice_state in ('rejected', 'error')"/>
            </xpath>
        </field>
    </record>

    <!-- Inherit Invoice Search View to Add E-Invoice Filters -->
    <record id="view_account_invoice_filter_einvoice" model="ir.ui.view">
        <field name="name">account.move.search.einvoice</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_invoice_filter"/>
        <field name="arch" type="xml">
            <!-- Add E-Invoice Filters -->
            <xpath expr="//filter[@name='draft']" position="after">
                <separator/>
                <filter string="E-Invoice Accepted" name="einvoice_accepted"
                        domain="[('l10n_cr_einvoice_state', '=', 'accepted')]"/>
                <filter string="E-Invoice Rejected" name="einvoice_rejected"
                        domain="[('l10n_cr_einvoice_state', '=', 'rejected')]"/>
                <filter string="E-Invoice Pending" name="einvoice_pending"
                        domain="[('l10n_cr_requires_einvoice', '=', True), ('l10n_cr_einvoice_state', 'in', ['draft', 'generated', 'signed', 'submitted'])]"/>
                <filter string="E-Invoice Error" name="einvoice_error"
                        domain="[('l10n_cr_einvoice_state', '=', 'error')]"/>
                <filter string="Requires E-Invoice" name="requires_einvoice"
                        domain="[('l10n_cr_requires_einvoice', '=', True)]"/>
            </xpath>

            <!-- Add Group By for E-Invoice State -->
            <xpath expr="//filter[@name='invoice_date']" position="after">
                <filter string="E-Invoice Status" name="group_einvoice_state"
                        context="{'group_by': 'l10n_cr_einvoice_state'}"/>
            </xpath>
        </field>
    </record>

    <!-- Action: Invoices Requiring E-Invoice -->
    <record id="action_invoices_requiring_einvoice" model="ir.actions.act_window">
        <field name="name">Invoices Requiring E-Invoice</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('l10n_cr_requires_einvoice', '=', True), ('state', '=', 'posted')]</field>
        <field name="context">{'search_default_einvoice_pending': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No invoices requiring electronic invoicing
            </p>
            <p>
                All posted invoices for Costa Rican customers require electronic invoicing.
            </p>
        </field>
    </record>

    <!-- Action: Invoices with E-Invoice Errors -->
    <record id="action_invoices_einvoice_errors" model="ir.actions.act_window">
        <field name="name">E-Invoice Errors</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('l10n_cr_einvoice_state', '=', 'error')]</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No e-invoice errors
            </p>
            <p>
                Great! All electronic invoices have been processed successfully.
            </p>
        </field>
    </record>

</odoo>

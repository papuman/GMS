<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit Invoice Form View to Add E-Invoice Integration -->
    <record id="view_move_form_einvoice" model="ir.ui.view">
        <field name="name">account.move.form.einvoice</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">

            <!-- Add E-Invoice Status Button to Button Box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_create_einvoice"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-file-code-o"
                        invisible="not l10n_cr_requires_einvoice or l10n_cr_einvoice_id"
                        context="{'default_move_id': id}">
                    <span class="o_stat_text">Create</span>
                    <span class="o_stat_text">E-Invoice</span>
                </button>

                <button name="action_create_einvoice"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-file-code-o"
                        invisible="not l10n_cr_einvoice_id"
                        context="{'default_move_id': id}">
                    <span class="o_stat_value">
                        <field name="l10n_cr_einvoice_state"
                               widget="badge"
                               decoration-muted="l10n_cr_einvoice_state == 'draft'"
                               decoration-info="l10n_cr_einvoice_state == 'generated'"
                               decoration-primary="l10n_cr_einvoice_state == 'signed'"
                               decoration-warning="l10n_cr_einvoice_state == 'submitted'"
                               decoration-success="l10n_cr_einvoice_state == 'accepted'"
                               decoration-danger="l10n_cr_einvoice_state in ('rejected', 'error')"/>
                    </span>
                    <span class="o_stat_text">E-Invoice</span>
                </button>
            </xpath>

            <!-- Add E-Invoice Action Buttons in Header -->
            <xpath expr="//header" position="inside">
                <button name="action_generate_and_send_einvoice"
                        string="Generate &amp; Send E-Invoice"
                        type="object"
                        class="oe_highlight"
                        invisible="not l10n_cr_requires_einvoice or l10n_cr_einvoice_state == 'accepted'"
                        confirm="This will generate the electronic invoice, sign it, submit to Hacienda and send email. Continue?"/>
            </xpath>

            <!-- Add Payment Method Fields After Payment Terms (Phase 1A) -->
            <xpath expr="//field[@name='invoice_payment_term_id']" position="after">
                <field name="l10n_cr_payment_method_id"
                       widget="selection"
                       placeholder="Select Payment Method"
                       invisible="not l10n_cr_requires_einvoice"
                       options="{'no_create': True, 'no_open': True}"/>
                <field name="l10n_cr_payment_transaction_id"
                       placeholder="Enter transaction ID (e.g., SINPE Móvil reference)"
                       invisible="not l10n_cr_payment_method_id or not l10n_cr_payment_method_id.requires_transaction_id"/>
                <field name="debit_origin_id"
                       placeholder="Select Original Invoice (for Debit Notes)"
                       invisible="move_type != 'out_invoice'"
                       options="{'no_create': True}"/>
            </xpath>

            <!-- Add E-Invoice Information Group -->
            <xpath expr="//group[@id='header_right_group']" position="after">
                <group name="einvoice_group" string="Electronic Invoice (Costa Rica)"
                       invisible="not l10n_cr_requires_einvoice"
                       groups="account.group_account_invoice">
                    <group>
                        <field name="l10n_cr_requires_einvoice" invisible="1"/>
                        <field name="l10n_cr_einvoice_id" readonly="1"/>
                        <field name="l10n_cr_einvoice_state"
                               widget="badge"
                               decoration-muted="l10n_cr_einvoice_state == 'draft'"
                               decoration-info="l10n_cr_einvoice_state == 'generated'"
                               decoration-primary="l10n_cr_einvoice_state == 'signed'"
                               decoration-warning="l10n_cr_einvoice_state == 'submitted'"
                               decoration-success="l10n_cr_einvoice_state == 'accepted'"
                               decoration-danger="l10n_cr_einvoice_state in ('rejected', 'error')"/>
                    </group>
                    <group>
                        <field name="l10n_cr_clave" readonly="1" widget="CopyClipboardChar"
                               invisible="not l10n_cr_clave"/>
                    </group>
                </group>
            </xpath>

        </field>
    </record>

    <!-- TODO: Fix Odoo 19 - discount field XPath needs update for invoice line views -->
    <!-- Inherit Invoice Line Form View to Add Discount Code Fields (Phase 1B) -->
    <!--
    <record id="view_move_line_form_discount_code" model="ir.ui.view">
        <field name="name">account.move.line.form.discount.code</field>
        <field name="model">account.move.line</field>
        <field name="inherit_id" ref="account.view_move_line_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='discount']" position="after">
                <field name="l10n_cr_discount_code_id"
                       widget="selection"
                       placeholder="Select Discount Code"
                       invisible="parent.move_type not in ('out_invoice', 'out_refund') or parent.country_code != 'CR'"
                       options="{'no_create': True, 'no_open': True}"
                       context="{'active_test': True}"/>
                <field name="l10n_cr_discount_code_requires_description" invisible="1"/>
                <field name="l10n_cr_discount_description"
                       placeholder="Required for code '99 - Otro' (max 75 chars)"
                       invisible="not l10n_cr_discount_code_requires_description"/>
            </xpath>
        </field>
    </record>
    -->

    <!-- Inherit Invoice Line Tree View to Add Discount Code Column (Phase 1B) -->
    <!--
    <record id="view_invoice_line_tree_discount_code" model="ir.ui.view">
        <field name="name">account.move.line.tree.discount.code</field>
        <field name="model">account.move.line</field>
        <field name="inherit_id" ref="account.view_invoice_line_list"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='discount']" position="after">
                <field name="l10n_cr_discount_code_id"
                       string="Discount Code (CR)"
                       optional="hide"
                       widget="badge"/>
            </xpath>
        </field>
    </record>
    -->

    <!-- TODO: Fix Odoo 19 - payment_state field XPath needs update for invoice tree view -->
    <!-- Inherit Invoice Tree View to Show E-Invoice Status and Payment Method -->
    <!--
    <record id="view_move_tree_einvoice" model="ir.ui.view">
        <field name="name">account.move.tree.einvoice</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_invoice_list"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='payment_state']" position="after">
                <field name="l10n_cr_einvoice_state"
                       string="E-Invoice"
                       optional="show"
                       widget="badge"
                       decoration-muted="l10n_cr_einvoice_state == 'draft'"
                       decoration-info="l10n_cr_einvoice_state == 'generated'"
                       decoration-primary="l10n_cr_einvoice_state == 'signed'"
                       decoration-warning="l10n_cr_einvoice_state == 'submitted'"
                       decoration-success="l10n_cr_einvoice_state == 'accepted'"
                       decoration-danger="l10n_cr_einvoice_state in ('rejected', 'error')"/>
                <field name="l10n_cr_payment_method_id"
                       string="Payment Method (CR)"
                       optional="hide"/>
            </xpath>
        </field>
    </record>
    -->

    <!-- Inherit Invoice Search View to Add E-Invoice Filters -->
    <record id="view_account_invoice_filter_einvoice" model="ir.ui.view">
        <field name="name">account.move.search.einvoice</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_invoice_filter"/>
        <field name="arch" type="xml">
            <!-- Add E-Invoice Filters -->
            <xpath expr="//filter[@name='draft']" position="after">
                <separator/>
                <filter string="E-Invoice Accepted" name="einvoice_accepted"
                        domain="[('l10n_cr_einvoice_state', '=', 'accepted')]"/>
                <filter string="E-Invoice Rejected" name="einvoice_rejected"
                        domain="[('l10n_cr_einvoice_state', '=', 'rejected')]"/>
                <filter string="E-Invoice Pending" name="einvoice_pending"
                        domain="[('l10n_cr_requires_einvoice', '=', True), ('l10n_cr_einvoice_state', 'in', ['draft', 'generated', 'signed', 'submitted'])]"/>
                <filter string="E-Invoice Error" name="einvoice_error"
                        domain="[('l10n_cr_einvoice_state', '=', 'error')]"/>
                <filter string="Requires E-Invoice" name="requires_einvoice"
                        domain="[('l10n_cr_requires_einvoice', '=', True)]"/>
                <separator/>
                <filter string="SINPE Móvil Payments" name="sinpe_payments"
                        domain="[('l10n_cr_payment_method_id.code', '=', '06')]"/>
                <filter string="Card Payments" name="card_payments"
                        domain="[('l10n_cr_payment_method_id.code', '=', '02')]"/>
                <filter string="Cash Payments" name="cash_payments"
                        domain="[('l10n_cr_payment_method_id.code', '=', '01')]"/>
            </xpath>

            <!-- Add Group By for E-Invoice State and Payment Method -->
            <xpath expr="//filter[@name='invoice_date']" position="after">
                <filter string="E-Invoice Status" name="group_einvoice_state"
                        context="{'group_by': 'l10n_cr_einvoice_state'}"/>
                <filter string="Payment Method" name="group_payment_method"
                        context="{'group_by': 'l10n_cr_payment_method_id'}"/>
            </xpath>
        </field>
    </record>

    <!-- Action: Invoices Requiring E-Invoice -->
    <record id="action_invoices_requiring_einvoice" model="ir.actions.act_window">
        <field name="name">Invoices Requiring E-Invoice</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('l10n_cr_requires_einvoice', '=', True), ('state', '=', 'posted')]</field>
        <field name="context">{'search_default_einvoice_pending': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No invoices requiring electronic invoicing
            </p>
            <p>
                All posted invoices for Costa Rican customers require electronic invoicing.
            </p>
        </field>
    </record>

    <!-- Action: Invoices with E-Invoice Errors -->
    <record id="action_invoices_einvoice_errors" model="ir.actions.act_window">
        <field name="name">E-Invoice Errors</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('l10n_cr_einvoice_state', '=', 'error')]</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No e-invoice errors
            </p>
            <p>
                Great! All electronic invoices have been processed successfully.
            </p>
        </field>
    </record>

</odoo>

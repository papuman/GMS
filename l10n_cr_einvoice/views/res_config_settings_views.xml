<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit Settings to Add Hacienda Configuration -->
    <record id="res_config_settings_view_form_einvoice" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.einvoice</field>
        <field name="model">res.config.settings</field>
        <field name="inherit_id" ref="account.res_config_settings_view_form"/>
        <field name="arch" type="xml">

            <!-- Add Costa Rica E-Invoicing Section -->
            <xpath expr="//div[@id='localization_settings']" position="after">
                <div class="app_settings_block" data-string="Costa Rica Electronic Invoicing"
                     data-key="l10n_cr_einvoice"
                     groups="account.group_account_manager">

                    <h2>Costa Rica Electronic Invoicing</h2>

                    <div class="row mt16 o_settings_container">
                        <!-- Hacienda API Configuration -->
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <field name="l10n_cr_hacienda_env" widget="radio" options="{'horizontal': true}"/>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="l10n_cr_hacienda_env"/>
                                <div class="text-muted">
                                    Select the Hacienda API environment (use Sandbox for testing)
                                </div>
                            </div>
                        </div>

                        <!-- API Credentials -->
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane"/>
                            <div class="o_setting_right_pane">
                                <label for="l10n_cr_active_username" string="API Credentials"/>
                                <div class="text-muted mb-2">
                                    Hacienda API authentication credentials
                                </div>
                                <div class="content-group">
                                    <div class="row mt8">
                                        <label for="l10n_cr_active_username" string="Username" class="col-lg-3 o_light_label"/>
                                        <field name="l10n_cr_active_username" placeholder="cpj-xxx-xxxxxx"/>
                                    </div>
                                    <div class="row mt8">
                                        <label for="l10n_cr_active_password" string="Password" class="col-lg-3 o_light_label"/>
                                        <field name="l10n_cr_active_password" password="True" placeholder="API Password"/>
                                    </div>
                                </div>
                                <div class="mt8">
                                    <button name="action_test_hacienda_connection"
                                            string="Test Connection"
                                            type="object"
                                            class="btn-link"
                                            icon="fa-plug">
                                        <i class="fa fa-plug"/> Test Connection
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt16 o_settings_container">
                        <!-- Digital Certificate -->
                        <div class="col-12 o_setting_box">
                            <div class="o_setting_left_pane"/>
                            <div class="o_setting_right_pane">
                                <label for="l10n_cr_active_certificate" string="Digital Certificate"/>
                                <div class="text-muted mb-2">
                                    Upload your X.509 digital certificate and private key for signing electronic invoices
                                </div>
                                <div class="content-group">
                                    <div class="row mt8">
                                        <label for="l10n_cr_active_certificate" string="Certificate (.p12 / .pem)" class="col-lg-3 o_light_label"/>
                                        <field name="l10n_cr_active_certificate" filename="l10n_cr_active_certificate_filename"/>
                                        <field name="l10n_cr_active_certificate_filename" invisible="1"/>
                                    </div>
                                    <div class="row mt8">
                                        <label for="l10n_cr_active_private_key" string="Private Key (.key or .pem)" class="col-lg-3 o_light_label"/>
                                        <field name="l10n_cr_active_private_key" filename="l10n_cr_active_private_key_filename"/>
                                        <field name="l10n_cr_active_private_key_filename" invisible="1"/>
                                    </div>
                                    <div class="row mt8">
                                        <label for="l10n_cr_active_key_password" string="Key Password (if encrypted)" class="col-lg-3 o_light_label"/>
                                        <field name="l10n_cr_active_key_password" password="True" placeholder="Leave empty if not encrypted"/>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-3" role="alert">
                                    <i class="fa fa-info-circle" title="Information"/> The certificate must be issued by a recognized Costa Rican CA
                                    and registered with Hacienda. For testing, you can use a self-signed certificate in Sandbox mode.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt16 o_settings_container">
                        <!-- Emisor Location -->
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane"/>
                            <div class="o_setting_right_pane">
                                <label for="l10n_cr_emisor_location" string="Emisor Location Code"/>
                                <div class="text-muted mb-2">
                                    8-digit location code: Provincia-Canton-Distrito-Barrio
                                </div>
                                <div class="content-group">
                                    <field name="l10n_cr_emisor_location" placeholder="01010100"/>
                                </div>
                                <div class="text-muted mt-2">
                                    Example: 01010100 for San Jos√©, Carmen, Merced, La California
                                </div>
                            </div>
                        </div>

                        <!-- Software Provider ID (v4.4 ProveedorSistemas) -->
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane"/>
                            <div class="o_setting_right_pane">
                                <label for="l10n_cr_proveedor_sistemas" string="Software Provider ID"/>
                                <div class="text-muted mb-2">
                                    Cedula of the software developer/provider (required by Hacienda v4.4).
                                    If empty, the company VAT is used as fallback.
                                </div>
                                <div class="content-group">
                                    <field name="l10n_cr_proveedor_sistemas" placeholder="3101XXXXXX"/>
                                </div>
                            </div>
                        </div>

                        <!-- Email Template -->
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane"/>
                            <div class="o_setting_right_pane">
                                <label for="l10n_cr_einvoice_email_template_id" string="Email Template"/>
                                <div class="text-muted mb-2">
                                    Template for sending electronic invoices to customers
                                </div>
                                <div class="content-group">
                                    <field name="l10n_cr_einvoice_email_template_id"
                                           domain="[('model', '=', 'account.move')]"
                                           context="{'default_model': 'account.move'}"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt16 o_settings_container">
                        <div class="col-12">
                            <h3>Automation Settings</h3>
                        </div>

                        <!-- Auto-generate E-Invoice -->
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <field name="l10n_cr_auto_generate_einvoice"/>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="l10n_cr_auto_generate_einvoice"/>
                                <div class="text-muted">
                                    Automatically create electronic invoice when posting invoices for CR customers
                                </div>
                            </div>
                        </div>

                        <!-- Auto-submit to Hacienda -->
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <field name="l10n_cr_auto_submit_einvoice"/>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="l10n_cr_auto_submit_einvoice"/>
                                <div class="text-muted">
                                    Automatically submit signed electronic invoices to Hacienda
                                </div>
                                <div class="alert alert-warning mt-2" role="alert" invisible="not l10n_cr_auto_submit_einvoice">
                                    <i class="fa fa-warning"/> Warning: This will automatically submit ALL invoices to Hacienda.
                                    Make sure your certificate and credentials are correctly configured.
                                </div>
                            </div>
                        </div>

                        <!-- Auto-send Email -->
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <field name="l10n_cr_auto_send_email"/>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="l10n_cr_auto_send_email"/>
                                <div class="text-muted">
                                    Automatically send email to customer when e-invoice is accepted by Hacienda
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt32">
                        <div class="col-12">
                            <div class="alert alert-info" role="alert">
                                <h4 class="alert-heading">
                                    <i class="fa fa-info-circle" title="Information"/> Getting Started with Costa Rica E-Invoicing
                                </h4>
                                <ol class="mb-0">
                                    <li>Register your company with Hacienda and obtain API credentials</li>
                                    <li>Obtain a valid X.509 digital certificate from a recognized CA</li>
                                    <li>Configure the settings above (start with Sandbox environment for testing)</li>
                                    <li>Test the connection to Hacienda API</li>
                                    <li>Create a test invoice and verify the complete workflow</li>
                                    <li>Once verified, switch to Production environment</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                </div>
            </xpath>

        </field>
    </record>

</odoo>

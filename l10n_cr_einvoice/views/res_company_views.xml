<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit Company Form View to Add Hacienda Configuration Tab -->
    <record id="view_company_form_einvoice" model="ir.ui.view">
        <field name="name">res.company.form.einvoice</field>
        <field name="model">res.company</field>
        <field name="inherit_id" ref="base.view_company_form"/>
        <field name="arch" type="xml">

            <!-- Add Hacienda Configuration Tab -->
            <xpath expr="//notebook" position="inside">
                <page string="Hacienda (CR E-Invoicing)" name="hacienda_config"
                      groups="account.group_account_manager">

                    <group string="Hacienda API Configuration">
                        <group>
                            <field name="l10n_cr_hacienda_env" widget="radio" options="{'horizontal': true}"/>
                            <field name="l10n_cr_active_username" placeholder="cpj-xxx-xxxxxx"/>
                            <field name="l10n_cr_active_password" password="True"/>
                        </group>
                        <group>
                            <field name="l10n_cr_emisor_location" placeholder="01010100"/>
                            <div class="text-muted">
                                8-digit location code: Provincia-Canton-Distrito-Barrio
                                <br/>
                                Example: 01010100 for San Jos√©, Carmen, Merced, La California
                            </div>
                        </group>
                    </group>

                    <div class="mt-2 mb-3">
                        <button name="action_test_hacienda_connection" type="object"
                                string="Test Connection" class="btn-secondary"
                                icon="fa-plug"/>
                    </div>

                    <separator string="Digital Certificate"/>
                    <group>
                        <group>
                            <field name="l10n_cr_active_certificate" filename="l10n_cr_active_certificate_filename"
                                   string="Certificate File (.p12)"/>
                            <field name="l10n_cr_active_certificate_filename" readonly="1"/>
                            <field name="l10n_cr_active_key_password" password="True"
                                   string="Certificate PIN / Password"
                                   placeholder="PIN provided with your .p12 certificate"/>
                        </group>
                        <group>
                            <div class="text-muted">
                                <strong>For .p12 certificates (recommended):</strong>
                                <br/>
                                Upload your .p12 file and enter the PIN. No separate private key needed.
                            </div>
                            <field name="l10n_cr_needs_private_key" invisible="1"/>
                            <field name="l10n_cr_active_private_key" filename="l10n_cr_active_private_key_filename"
                                   string="Private Key (PEM only)"
                                   invisible="not l10n_cr_needs_private_key"/>
                            <field name="l10n_cr_active_private_key_filename" readonly="1"
                                   invisible="not l10n_cr_needs_private_key"/>
                        </group>
                    </group>

                    <div class="alert alert-info mt-3" role="alert">
                        <i class="fa fa-info-circle" title="Certificate Information"/>
                        <strong>Certificate Information:</strong>
                        <ul class="mb-0">
                            <li><strong>Recommended:</strong> Upload your .p12 file (PKCS#12) provided by Hacienda and enter the PIN</li>
                            <li>PEM format (.pem/.crt + separate .key file) is also supported</li>
                            <li>Must be issued by a recognized Costa Rican Certificate Authority</li>
                            <li>Must be registered with the Ministry of Finance (Hacienda)</li>
                        </ul>
                    </div>

                    <separator string="Automation Settings"/>
                    <group>
                        <group>
                            <field name="l10n_cr_auto_generate_einvoice"/>
                            <field name="l10n_cr_auto_submit_einvoice"/>
                            <field name="l10n_cr_auto_send_email"/>
                        </group>
                        <group>
                            <field name="l10n_cr_einvoice_email_template_id"
                                   domain="[('model', '=', 'account.move')]"
                                   context="{'default_model': 'account.move'}"/>
                        </group>
                    </group>

                </page>
            </xpath>

        </field>
    </record>

</odoo>

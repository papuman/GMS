<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">

    <!-- E-Invoice controls on PaymentScreen — reads einvoiceState (useState) directly for reactivity -->
    <t t-name="l10n_cr_einvoice.PaymentScreenButtons" t-inherit="point_of_sale.PaymentScreenButtons" t-inherit-mode="extension">
        <xpath expr="//div[hasclass('payment-buttons')]" position="before">
            <t t-if="currentOrder">
                <!-- E-Invoice Toggle -->
                <div class="einvoice-section mb-3">
                    <button type="button"
                            t-attf-class="btn btn-lg w-100 {{einvoiceState.enabled ? 'btn-success' : 'btn-light border'}}"
                            t-on-click="() => this.toggleEinvoiceEnabled()">
                        <i t-attf-class="fa {{einvoiceState.enabled ? 'fa-check-circle' : 'fa-circle-o'}} me-2"/>
                        <t t-if="einvoiceState.enabled">
                            <strong>Factura Electrónica</strong> (Activada)
                        </t>
                        <t t-else="">
                            Factura Electrónica
                        </t>
                    </button>

                    <!-- Document type selector - only when enabled -->
                    <t t-if="einvoiceState.enabled">
                        <div class="d-flex gap-2 mt-2">
                            <button type="button"
                                    t-attf-class="btn flex-fill {{einvoiceState.type === 'TE' ? 'btn-primary' : 'btn-outline-secondary'}}"
                                    t-on-click="() => this.selectTiquete()">
                                <i class="fa fa-ticket me-1"/> Tiquete
                            </button>
                            <button type="button"
                                    t-attf-class="btn flex-fill {{einvoiceState.type === 'FE' ? 'btn-primary' : 'btn-outline-secondary'}}"
                                    t-on-click="() => this.selectFactura()">
                                <i class="fa fa-building me-1"/> Factura
                            </button>
                        </div>
                    </t>
                </div>
            </t>
        </xpath>
    </t>

    <!--
        Override the Validate button to use canValidateOrder (PaymentScreen getter)
        instead of currentOrder.canBeValidated() (PosOrder method).

        This is critical because the e-invoice state lives in einvoiceState (useState)
        on the PaymentScreen component, which OWL tracks reactively. Reading from the
        PosOrder record through the WithLazyGetterTrap proxy is unreliable for
        triggering re-renders.

        The canValidateOrder getter combines:
        - Base Odoo validation (isPaid, isValidEmptyOrder, isRefundInProcess)
        - FE requirements (customer name, cédula, email, CIIU) when Factura is selected
    -->
    <t t-name="l10n_cr_einvoice.PaymentScreenValidate" t-inherit="point_of_sale.PaymentScreenValidate" t-inherit-mode="extension">
        <xpath expr="//button[hasclass('validation-button')]" position="attributes">
            <attribute name="t-attf-class">
                {{ ui.isSmall ? 'btn-switchpane flex-fill' : 'button next w-50' }}
                {{ canValidateOrder ? 'highlight' : 'disabled' }}
            </attribute>
        </xpath>
    </t>

</templates>

name: Odoo Module Tests - TiloPay Payment Gateway

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'payment_tilopay/**'
      - '.github/workflows/odoo-module-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'payment_tilopay/**'
  workflow_dispatch:

env:
  ODOO_VERSION: "19.0"
  PYTHON_VERSION: "3.11"
  POSTGRES_VERSION: "13"

jobs:
  # Job 1: Code Quality Checks (Fast Feedback)
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black isort bandit safety

      - name: Check code formatting with Black
        run: |
          echo "Checking Python code formatting..."
          black --check --diff payment_tilopay/
        continue-on-error: false

      - name: Check import sorting with isort
        run: |
          echo "Checking import statement ordering..."
          isort --check-only --diff payment_tilopay/
        continue-on-error: false

      - name: Lint with flake8
        run: |
          echo "Running flake8 linter..."
          # Stop the build if there are Python syntax errors or undefined names
          flake8 payment_tilopay/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          flake8 payment_tilopay/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Lint with pylint
        run: |
          echo "Running pylint..."
          # Create minimal .pylintrc for Odoo
          cat > .pylintrc << 'EOF'
          [MASTER]
          load-plugins=
          ignore=CVS,.git,__pycache__

          [MESSAGES CONTROL]
          disable=C0114,C0115,C0116,R0903,R0913,W0212,C0103,R0801

          [FORMAT]
          max-line-length=127

          [DESIGN]
          max-args=10
          max-attributes=15
          EOF

          pylint payment_tilopay/ --exit-zero --rcfile=.pylintrc
        continue-on-error: true

      - name: Security scan with Bandit
        run: |
          echo "Running security scan..."
          bandit -r payment_tilopay/ -f json -o bandit-report.json || true
          bandit -r payment_tilopay/ -ll
        continue-on-error: true

      - name: Upload bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30

  # Job 2: Dependency Security Check
  security:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check for known security vulnerabilities
        run: |
          pip install safety
          # Check if requirements.txt exists, create minimal one if not
          if [ ! -f requirements.txt ]; then
            echo "requests>=2.31.0" > requirements.txt
            echo "cryptography>=41.0.0" >> requirements.txt
          fi
          safety check --file=requirements.txt --json > safety-report.json || true
          safety check --file=requirements.txt
        continue-on-error: true

      - name: Upload safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-security-report
          path: safety-report.json
          retention-days: 30

  # Job 3: Module Installation Test
  install-test:
    name: Module Installation Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint]

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_DB: postgres
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libpq-dev \
            libxml2-dev \
            libxslt1-dev \
            libldap2-dev \
            libsasl2-dev \
            libssl-dev \
            libjpeg-dev \
            libfreetype6-dev \
            zlib1g-dev

      - name: Install Odoo dependencies
        run: |
          pip install --upgrade pip wheel setuptools
          pip install psycopg2-binary

          # Install Odoo from PyPI (for testing) or clone from source
          pip install odoo==${{ env.ODOO_VERSION }}
        continue-on-error: true

      - name: Alternative - Clone Odoo from source
        if: failure()
        run: |
          git clone --depth 1 --branch ${{ env.ODOO_VERSION }} https://github.com/odoo/odoo.git /tmp/odoo
          pip install -r /tmp/odoo/requirements.txt

      - name: Create test Odoo configuration
        run: |
          mkdir -p /tmp/odoo_test
          cat > /tmp/odoo.conf << EOF
          [options]
          admin_passwd = admin
          db_host = localhost
          db_port = 5432
          db_user = odoo
          db_password = odoo
          addons_path = /tmp/odoo/addons,${GITHUB_WORKSPACE}/payment_tilopay
          logfile = /tmp/odoo_test/odoo.log
          log_level = info
          EOF

      - name: Initialize Odoo database
        run: |
          # Initialize database with base modules
          python /tmp/odoo/odoo-bin -c /tmp/odoo.conf -d test_db --init base --stop-after-init --log-level=warn
        continue-on-error: true

      - name: Run installation validation script
        run: |
          python scripts/validate_installation.py
        continue-on-error: true

      - name: Upload installation logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: installation-logs
          path: /tmp/odoo_test/odoo.log
          retention-days: 7

  # Job 4: Unit Tests with Coverage
  test:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [lint]

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_DB: postgres
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libpq-dev libxml2-dev libxslt1-dev libldap2-dev \
            libsasl2-dev libssl-dev libjpeg-dev

          pip install --upgrade pip wheel
          pip install pytest pytest-cov pytest-odoo coverage
          pip install requests cryptography

      - name: Clone Odoo
        run: |
          git clone --depth 1 --branch ${{ env.ODOO_VERSION }} https://github.com/odoo/odoo.git /tmp/odoo
          pip install -r /tmp/odoo/requirements.txt

      - name: Run unit tests with coverage
        run: |
          export PYTHONPATH="/tmp/odoo:${GITHUB_WORKSPACE}:${PYTHONPATH}"

          # Run tests using Odoo's test framework
          python /tmp/odoo/odoo-bin -c /dev/null \
            --test-enable \
            --test-file=payment_tilopay/tests/ \
            --stop-after-init \
            --log-level=test \
            -d test_db \
            -i payment_tilopay
        continue-on-error: true

      - name: Generate coverage report
        run: |
          coverage run --source=payment_tilopay -m pytest payment_tilopay/tests/ || true
          coverage report -m
          coverage xml
          coverage html
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-payment-tilopay
          fail_ci_if_error: false

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        run: |
          COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}')
          echo "Total coverage: $COVERAGE"
        continue-on-error: true

  # Job 5: Docker Build Test
  docker-build:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test Docker Compose configuration
        run: |
          docker compose config

      - name: Build Docker images
        run: |
          docker compose build
        continue-on-error: true

      - name: Start services
        run: |
          docker compose up -d

      - name: Wait for services to be ready
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 60 bash -c 'until docker compose exec -T db pg_isready; do sleep 2; done'

          echo "Waiting for Odoo..."
          sleep 30

      - name: Check service health
        run: |
          docker compose ps
          docker compose logs --tail=50

      - name: Test Odoo accessibility
        run: |
          curl -f http://localhost:8070/web/health || echo "Health check failed"
        continue-on-error: true

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

  # Job 6: Integration Summary
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, security, install-test, test, docker-build]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Install Test: ${{ needs.install-test.result }}"
          echo "Unit Tests: ${{ needs.test.result }}"
          echo "Docker Build: ${{ needs.docker-build.result }}"

          if [[ "${{ needs.lint.result }}" == "failure" ]]; then
            echo "Code quality checks failed!"
            exit 1
          fi

      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # TiloPay Module Test Results

          ## Status Overview

          | Job | Status |
          |-----|--------|
          | Code Quality | ${{ needs.lint.result }} |
          | Security Scan | ${{ needs.security.result }} |
          | Installation | ${{ needs.install-test.result }} |
          | Unit Tests | ${{ needs.test.result }} |
          | Docker Build | ${{ needs.docker-build.result }} |

          ## Next Steps

          - Review any failed checks above
          - Check artifact uploads for detailed reports
          - Ensure all tests pass before merging

          EOF

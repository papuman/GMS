# Costa Rica E-Invoicing Historical Invoice Import Research

## Executive Summary

**Date:** 2025-12-29
**Research Focus:** How Costa Rica e-invoicing providers handle historical invoice imports when customers migrate from one system to another

### Key Findings:

1. **CRITICAL DISCOVERY**: Historical invoices are NOT re-submitted to Hacienda when migrating providers
2. **Industry Leader Example**: FACTURATica imported 100+ million historical invoices in "a matter of hours" during 2024 migrations
3. **Standard Practice**: Customers request XML files from old provider, new provider imports for reporting/archival purposes only
4. **Legal Requirement**: Must store invoice XML files for 5 years (per Article 109 Tax Code)
5. **No Official Migration Protocol**: Hacienda doesn't require re-validation of historical invoices when switching providers

---

## Section 1: THE REALITY - What Providers Actually Offer

### FACTURATica (Market Leader)

**Import Capability Status**: CONFIRMED - Feature launched in 2024

**Performance Metrics**:
- Imported 100+ million invoices from migrating customers in H1 2024
- Processing time: "Within a matter of hours" for massive datasets
- Historical data scope: Invoices dating back to 2020

**What They Import**:
- Both issued invoices AND purchase data
- Enables immediate access to historical reporting tools
- Preserves data continuity without loss

**Known Limitations**:
- No public documentation on file format requirements (XML, CSV, database export)
- No published technical specifications for data preparation
- Import process details not available in public knowledge base

**Source**: [FACTURATica imports 100M+ invoices](https://ticosland.com/facturatica-imports-over-100-million-electronic-invoices-from-recently-migrated-customers/)

### GTI Facturacion

**Import Capability**: LIMITED - Focuses on migration to other systems

**Documented Process**:
- Users can export data to Excel for migration to other platforms (e.g., Alegra)
- Supports importing "initial accounting balances" from Excel
- No mention of bulk XML invoice import capability

**Migration Pattern**:
- Export from GTI to Excel/CSV
- Import Excel/CSV to new system
- Metadata-focused rather than full XML preservation

**Source**: [GTI Facturacion analysis](https://programascontabilidad.com/analisis-de-herramientas/gti-facturacion-costa-rica/)

### TicoPay

**Import Capability**: PARTIAL - XML email reception

**Technical Approach**:
- Receives XML invoices via email: recepcion@confirmarxml.ticopays.com
- Automatically extracts and registers supplier data from XML
- Batch XML confirmation feature for multiple documents
- Can download original XML + Hacienda response XML

**Limitation**:
- Designed for ongoing invoice reception, not historical bulk import
- Requires emailing XMLs individually or in batches (not ideal for 1,200 invoices)

**Source**: [TicoPay XML confirmation](https://blog.ticopays.com/2019/03/13/confirmacion-de-xml-por-lote-nueva-funcionalidad-de-ticopay/)

### PROCOM

**Import Capability**: API-FOCUSED - Integration approach

**Technical Strengths**:
- Fully documented REST API for system integration
- Supports data migration activities during implementation
- Can continue using existing ERP/CRM/POS systems
- Automatic e-invoice 4.4 generation from existing workflows

**Implication**:
- Likely handles imports via API/database integration
- Not designed for self-service CSV upload by end users
- Requires technical implementation support

**Source**: [PROCOM features](https://www.procom.cr/cual-es-el-mejor-proveedor-de-facturacion-electronica-4-4-en-costa-rica/)

### Alegra

**Import Capability**: STANDARD CSV/EXCEL - Metadata import

**Documented Process**:
- Accepts Excel and CSV file imports
- Focuses on "initial balances" and accounting data migration
- No specific mention of XML import or preservation

**Likely Pattern**: Summary data import, not full XML archival

---

## Section 2: Migration Best Practices in Costa Rica

### What Customers MUST Do When Switching Providers

Based on industry blogs and provider guidance:

#### Step 1: Request XML Files from Old Provider

**Requirement**:
- Request ALL XML files generated by the old platform
- These are legally required for 5-year retention (Tax Code Article 109)
- Notify old provider you're discontinuing service

**Critical Detail**:
- Not just PDFs - you NEED the XML files
- XML contains digital signature and Hacienda validation
- Cannot be regenerated; must be preserved as original

**Source**: [Switching providers guide](https://blog.factun.com/facturacion-electronica/lo-que-debes-tomar-en-cuenta-al-cambiar-de-proveedor-de-factura-electronica)

#### Step 2: Preserve Consecutive Numbering

**Requirement**:
- Record the last consecutive number used for each document type:
  - Facturas (Invoices)
  - Notas de Crédito (Credit Notes)
  - Notas de Débito (Debit Notes)
  - Tiquetes Electrónicos (Electronic Tickets)

**Why It Matters**:
- Consecutive numbering CANNOT be reset when changing providers
- Must continue from where you left off (e.g., if last invoice was 00000001234, next is 00000001235)
- Sequential number is part of the 50-digit "clave" (access key) generation
- Only resets after reaching 9999999999

**Source**: [Migration data preparation](https://www.fonoa.com/resources/blog/practical-guide-to-e-invoicing-in-costa-rica)

#### Step 3: Revoke and Generate New Cryptographic Key

**Technical Process**:
1. Login to Hacienda's ATV system
2. Access "Comprobantes Electrónicos" section
3. Select "Revoke Cryptographic Production Key" (for old provider)
4. Generate new key and password (for new provider)
5. Provide new key to new provider
6. Screenshot/document new credentials

**Critical**: Must revoke old key before generating new one

**Source**: [Provider switching guide](https://blog.factun.com/facturacion-electronica/lo-que-debes-tomar-en-cuenta-al-cambiar-de-proveedor-de-factura-electronica)

### What Providers SHOULD Do (But May Not Offer)

**Ideal Migration Support**:
- Accept XML files in bulk (ZIP archive of 1,200 XMLs)
- Parse and validate XML structure
- Import to archive/reporting database
- Enable search and retrieval of historical invoices
- Generate PDF views from imported XML data
- Maintain original Hacienda "clave" (access key)
- Preserve digital signature information

**Reality Check**:
- Only FACTURATica publicly advertises this capability
- Most providers focus on forward-looking invoicing, not historical archival
- May require custom implementation or support team involvement

---

## Section 3: Data Format Examples

### Option A: Original XML Files (PREFERRED)

**What It Is**:
- The original XML files generated by the old e-invoicing system
- Contains complete invoice data in structured format
- Includes digital signature and Hacienda validation response

**Typical Structure** (Costa Rica e-invoice XML v4.4):

```xml
<?xml version="1.0" encoding="UTF-8"?>
<FacturaElectronica xmlns="https://cdn.comprobanteselectronicos.go.cr/xml-schemas/v4.4/facturaElectronica">
  <Clave>50601012024010100123456789012345678901234567890</Clave>
  <CodigoActividad>523110</CodigoActividad>
  <NumeroConsecutivo>00100001000000001234</NumeroConsecutivo>
  <FechaEmision>2024-01-01T10:30:00-06:00</FechaEmision>
  <Emisor>
    <Nombre>Mi Gimnasio CR</Nombre>
    <Identificacion>
      <Tipo>02</Tipo>
      <Numero>3101234567</Numero>
    </Identificacion>
    <!-- ... -->
  </Emisor>
  <Receptor>
    <Nombre>Juan Pérez</Nombre>
    <Identificacion>
      <Tipo>01</Tipo>
      <Numero>103450678</Numero>
    </Identificacion>
    <!-- ... -->
  </Receptor>
  <DetalleServicio>
    <LineaDetalle>
      <NumeroLinea>1</NumeroLinea>
      <Codigo>MENSUALIDAD-GYM</Codigo>
      <Descripcion>Membresía Mensual Gimnasio</Descripcion>
      <Cantidad>1</Cantidad>
      <UnidadMedida>Sp</UnidadMedida>
      <PrecioUnitario>50000.00</PrecioUnitario>
      <MontoTotal>50000.00</MontoTotal>
      <SubTotal>50000.00</SubTotal>
      <!-- Tax details ... -->
    </LineaDetalle>
  </DetalleServicio>
  <ResumenFactura>
    <TotalVenta>50000.00</TotalVenta>
    <TotalImpuesto>6500.00</TotalImpuesto>
    <TotalComprobante>56500.00</TotalComprobante>
  </ResumenFactura>
  <!-- Digital signature ... -->
</FacturaElectronica>
```

**Delivery Method**:
- ZIP file containing 1,200 individual XML files
- File naming: `{clave}.xml` or `{consecutive_number}.xml`
- Total size estimate: 2-5MB (typical invoice XML is 2-5KB)

**Pros**:
- Complete data preservation
- Can regenerate PDFs
- Maintains legal compliance (5-year retention)
- Contains original digital signature
- Hacienda validation status preserved

**Cons**:
- Requires XML parsing capability
- Complex data structure
- Need to handle various document types (invoices, credit notes, debit notes)

**Source**: [Costa Rica XML schema details](https://www.fonoa.com/resources/blog/practical-guide-to-e-invoicing-in-costa-rica)

---

### Option B: CSV/Excel Export (COMMON)

**What It Is**:
- Simplified invoice list exported from old system
- Contains key fields but NOT full invoice details
- Suitable for reporting and summary views

**Standard CSV Format** (based on FacturaDirecta and industry patterns):

```csv
"Fecha","Serie","Numero","Cliente_NIF","Cliente_Nombre","Concepto","Base_Imponible","IVA_Tipo","IVA_Cuota","Total","Moneda","Estado_Pago","Clave_Hacienda"
"2024-01-15","001","00000001234","103450678","Juan Pérez González","Membresía Mensual Enero 2024","50000.00","13","6500.00","56500.00","CRC","Pagado","50601012024011500123456789012345678901234567890"
"2024-01-16","001","00000001235","205670123","María López Solís","Membresía Anual 2024","480000.00","13","62400.00","542400.00","CRC","Pendiente","50601012024011600123456789012345678901234567891"
"2024-01-16","001","00000001236","304560789","Carlos Ramírez Castro","Clase Personal Training","75000.00","13","9750.00","84750.00","CRC","Pagado","50601012024011600123456789012345678901234567892"
```

**Required Fields** (minimum viable):

| Field | Format | Required | Example | Description |
|-------|--------|----------|---------|-------------|
| `Fecha` | YYYY-MM-DD | YES | 2024-01-15 | Invoice date |
| `Numero` | Text | YES | 00000001234 | Consecutive invoice number |
| `Cliente_NIF` | Text (no spaces) | YES | 103450678 | Customer tax ID |
| `Cliente_Nombre` | Text | YES | Juan Pérez | Customer name |
| `Total` | Decimal | YES | 56500.00 | Total invoice amount |
| `Moneda` | ISO 4217 | YES | CRC | Currency code |

**Optional But Recommended Fields**:

| Field | Format | Example | Description |
|-------|--------|---------|-------------|
| `Serie` | Text | 001 | Invoice series |
| `Concepto` | Text | Membresía Mensual | Line item description |
| `Base_Imponible` | Decimal | 50000.00 | Subtotal before tax |
| `IVA_Tipo` | Integer | 13 | Tax percentage (13% in CR) |
| `IVA_Cuota` | Decimal | 6500.00 | Tax amount |
| `Estado_Pago` | Text | Pagado/Pendiente | Payment status |
| `Clave_Hacienda` | Text (50 digits) | 5060101... | Hacienda access key |
| `Fecha_Vencimiento` | YYYY-MM-DD | 2024-02-15 | Due date |
| `Metodo_Pago` | Text | Tarjeta/Transferencia | Payment method |
| `Notas` | Text | Cliente preferente | Internal notes |

**File Structure Requirements**:
- First row: Column headers
- Subsequent rows: Invoice data
- Text fields: Enclosed in double quotes
- Field separator: Comma
- Decimal separator: Period (.)
- Encoding: UTF-8 (to handle Spanish characters: ñ, á, é, etc.)

**Pros**:
- Simple to export from most systems
- Easy to validate and import
- Human-readable
- Quick to generate and process

**Cons**:
- Loses invoice line item details (if multiple products per invoice)
- No digital signature preservation
- Cannot regenerate official XML
- Limited to single tax rate per invoice (multi-line invoices problematic)

**Source**: [FacturaDirecta CSV format](https://help.facturadirecta.com/es/articles/1070807-importar-facturas-y-gastos-en-excel-o-csv)

---

### Option C: API Integration (ADVANCED)

**What It Is**:
- Direct database-to-database transfer
- New provider's system pulls data from old provider's API (if available)
- Or new provider imports from database backup/export

**Technical Approach**:

```http
POST /api/v1/invoices/bulk-import
Authorization: Bearer {api_token}
Content-Type: application/json

{
  "source": "old_provider_name",
  "date_range": {
    "start": "2024-01-01",
    "end": "2024-12-31"
  },
  "invoice_ids": [1234, 1235, 1236, ...], // or "all"
  "include_xml": true,
  "include_pdf": false,
  "preserve_consecutive": true
}
```

**Response Example**:

```json
{
  "import_id": "imp_20250101_abc123",
  "status": "processing",
  "total_invoices": 1200,
  "processed": 0,
  "estimated_completion": "2025-01-01T15:30:00Z",
  "webhook_url": "https://your-system.com/import-complete"
}
```

**Pros**:
- Automated, no manual file handling
- Can preserve full data structure
- Fastest for large datasets
- Real-time validation and error reporting

**Cons**:
- Requires both providers to support API integration
- Unlikely between competing providers
- Needs technical development
- Security/authentication complexities

**Source**: [PROCOM API capabilities](https://www.procom.cr/)

---

### Option D: Database Export/Backup (RARE)

**What It Is**:
- SQL dump or database backup from old provider
- New provider imports directly into their database structure

**Reality**:
- Providers use different database schemas
- Not offered due to data structure incompatibilities
- Security and privacy concerns
- Only viable for same-vendor upgrades (e.g., Odoo 15 to Odoo 18)

**Verdict**: Not a practical option for cross-provider migration

---

## Section 4: Technical Workflow - Step by Step

### Scenario: Gym Owner Migrating from Old Provider to Odoo

**Context**:
- Current provider: Generic e-invoice SaaS
- Migration date: January 1, 2025
- Historical data: 1,200 invoices from 2024
- New system: Odoo with l10n_cr module

---

### PHASE 1: Pre-Migration (December 2024)

#### Week 1: Data Audit

**Customer Actions**:

1. **Request XML Archive from Old Provider**
   ```
   Email to: support@old-provider.com
   Subject: Request for Complete XML Invoice Archive

   Dear Support Team,

   We will be discontinuing service as of December 31, 2024.
   Please provide:
   - All XML files for invoices issued in 2024 (approx. 1,200 files)
   - All XML files for credit/debit notes issued in 2024
   - Hacienda response XMLs (acceptance messages)
   - Export format: ZIP archive
   - Delivery method: Download link or email

   Tax ID: 3-101-234567
   Account: account@mygym.cr
   ```

2. **Document Last Consecutive Numbers**
   - Log into old provider dashboard
   - Record last invoice number: 00000001234
   - Record last credit note number: 00000000045
   - Record last debit note number: 00000000012
   - Screenshot for verification

3. **Prepare Customer/Product Data**
   - Export customer list with tax IDs
   - Export product/service catalog
   - Export tax configuration
   - Export price lists

**Expected Deliverable from Old Provider**:
- `invoices_2024.zip` (10-15 MB for 1,200 invoices)
  - Contains: `factura_001_0001234.xml`, `factura_001_0001235.xml`, etc.
  - Includes: Hacienda response files: `factura_001_0001234_response.xml`

**Timeline**: 3-5 business days for old provider to prepare export

---

#### Week 2: Odoo Setup

**Technical Implementation**:

1. **Install Odoo Modules**
   ```bash
   # Install Costa Rica localization
   - l10n_cr (base localization)
   - l10n_cr_invoice (e-invoicing v4.4)
   - l10n_cr_reports (tax reports)
   ```

2. **Configure Company Settings**
   - Company Tax ID: 3-101-234567
   - CIIU Code: 931101 (Gym operations)
   - Cryptographic key: (new key from Hacienda ATV)
   - Hacienda API credentials (sandbox for testing)

3. **Set Consecutive Numbers**
   - Navigate to: Accounting > Configuration > Journals
   - Sales Journal: Set next invoice number to 00000001235
   - Configure invoice series: `001`

4. **Import Master Data**
   - Import customers from CSV
   - Import products/services
   - Configure tax rates (13% IVA)
   - Set up payment terms

---

#### Week 3: Hacienda Key Migration

**Customer Actions**:

1. **Login to Hacienda ATV**
   - URL: https://atv.hacienda.go.cr/
   - Navigate to: Comprobantes Electrónicos > Llave Criptográfica

2. **Revoke Old Key**
   - Select: "Revocar Llave Criptográfica de Producción"
   - Confirm revocation for old provider

3. **Generate New Key**
   - Select: "Generar Llave Criptográfica de Producción"
   - Create 4-digit PIN (e.g., 1234)
   - Download `.p12` certificate file
   - Screenshot credentials

4. **Configure Odoo with New Key**
   - Upload `.p12` file to Odoo
   - Enter PIN
   - Test connection to Hacienda (sandbox first)

**Timeline**: 1-2 days including testing

---

### PHASE 2: Historical Import (January 1, 2025)

#### Option 2A: XML Import (IDEAL - if module exists)

**Technical Process**:

```python
# Pseudocode for Odoo XML import module

def import_historical_invoices(xml_zip_file):
    """
    Import historical e-invoices from XML files
    """
    # Step 1: Extract ZIP archive
    invoices_xml = extract_zip(xml_zip_file)

    # Step 2: Parse each XML
    for xml_file in invoices_xml:
        try:
            # Parse XML structure
            invoice_data = parse_cr_einvoice_xml(xml_file)

            # Extract key fields
            clave = invoice_data['Clave']  # 50-digit key
            consecutive = invoice_data['NumeroConsecutivo']
            date = invoice_data['FechaEmision']
            customer_id = invoice_data['Receptor']['Identificacion']['Numero']
            total = invoice_data['ResumenFactura']['TotalComprobante']

            # Step 3: Create invoice record (archived)
            invoice = {
                'type': 'out_invoice',
                'state': 'posted',  # Already issued/validated
                'invoice_date': date,
                'partner_id': get_or_create_partner(customer_id),
                'name': consecutive,  # Invoice number
                'l10n_cr_clave': clave,  # Store Hacienda key
                'l10n_cr_historical': True,  # Flag as imported
                'l10n_cr_xml_original': xml_file.read(),  # Store original XML
                'invoice_line_ids': parse_invoice_lines(invoice_data)
            }

            # Step 4: Create invoice without triggering Hacienda submission
            created_invoice = env['account.move'].with_context(
                skip_hacienda_validation=True,  # Critical flag
                historical_import=True
            ).create(invoice)

            # Step 5: Generate PDF from XML for viewing
            generate_pdf_from_xml(created_invoice, invoice_data)

            print(f"✓ Imported: {consecutive} - {customer_name} - ₡{total}")

        except Exception as e:
            log_error(f"Failed to import {xml_file}: {e}")
            continue

    return {
        'imported': len(successful_imports),
        'failed': len(failed_imports),
        'duration': end_time - start_time
    }
```

**User Workflow in Odoo**:

1. Navigate to: `Accounting > Configuration > Historical Import`
2. Upload `invoices_2024.zip`
3. Select import options:
   - ☑ Create invoice records (for reporting)
   - ☑ Store original XML (for compliance)
   - ☑ Generate PDF previews
   - ☐ Update customer balances (usually NO - invoices already paid)
4. Click "Import"
5. Monitor progress bar: "Importing 1,200 invoices..."
6. Review import log:
   ```
   ✓ 1,189 invoices imported successfully
   ✗ 11 invoices failed (see error log)
   ```
7. Fix failed imports manually (if needed)

**Expected Processing Time**:
- XML parsing: ~0.5 seconds per invoice
- Database insertion: ~0.2 seconds per invoice
- PDF generation: ~1 second per invoice (optional, can be done on-demand)
- **Total for 1,200 invoices: ~20-30 minutes**

**Storage Requirements**:
- XML files: 10-15 MB
- Database records: ~500 KB (metadata only)
- Generated PDFs: 50-100 MB (optional)
- **Total: ~110 MB**

---

#### Option 2B: CSV Import (REALISTIC - available now)

**Technical Process**:

```python
# Pseudocode for CSV import (simpler)

def import_invoices_csv(csv_file):
    """
    Import invoice summary from CSV
    """
    df = read_csv(csv_file)

    for index, row in df.iterrows():
        try:
            # Create simplified invoice record
            invoice = {
                'type': 'out_invoice',
                'state': 'posted',
                'invoice_date': row['Fecha'],
                'partner_id': get_partner_by_vat(row['Cliente_NIF']),
                'name': row['Numero'],
                'l10n_cr_clave': row['Clave_Hacienda'],
                'l10n_cr_historical': True,
                'invoice_line_ids': [(0, 0, {
                    'name': row['Concepto'],
                    'quantity': 1,
                    'price_unit': row['Base_Imponible'],
                    'tax_ids': get_tax_by_percentage(row['IVA_Tipo'])
                })]
            }

            env['account.move'].with_context(
                skip_hacienda_validation=True
            ).create(invoice)

        except Exception as e:
            log_error(f"Row {index}: {e}")
            continue
```

**User Workflow in Odoo**:

1. Prepare CSV file (export from old system or manually create)
2. Navigate to: `Accounting > Customers > Invoices`
3. Click "Import" button (Odoo built-in import)
4. Upload `invoices_2024.csv`
5. Map columns:
   - "Fecha" → Invoice Date
   - "Numero" → Invoice Number
   - "Cliente_NIF" → Partner (matched by VAT)
   - "Total" → Amount Total
   - etc.
6. Test import with first 10 rows
7. Review and confirm mapping
8. Import all 1,200 rows
9. Review import results

**Expected Processing Time**:
- CSV parsing: ~0.1 seconds per row
- Database insertion: ~0.2 seconds per invoice
- **Total for 1,200 invoices: ~5-10 minutes**

**Limitations**:
- Loses XML original (must store separately)
- Simplified invoice structure (single line item)
- Manual PDF generation not possible
- No digital signature preservation

---

### PHASE 3: Post-Migration Validation

**Validation Checklist**:

1. **Data Integrity Check**
   ```sql
   -- Verify invoice count
   SELECT COUNT(*) FROM account_move
   WHERE l10n_cr_historical = TRUE
   AND invoice_date >= '2024-01-01'
   AND invoice_date <= '2024-12-31';
   -- Expected: 1,200

   -- Verify total amount
   SELECT SUM(amount_total) FROM account_move
   WHERE l10n_cr_historical = TRUE
   AND invoice_date >= '2024-01-01';
   -- Compare with old system total
   ```

2. **Customer Account Verification**
   - Check customer list: Do all 1,200 invoices have valid customers?
   - Verify tax IDs match
   - Confirm no duplicate customer records created

3. **Tax Reporting Test**
   - Generate 2024 tax report (D104 form)
   - Verify totals match old system
   - Ensure historical invoices appear in reports

4. **XML Archival Verification**
   - Confirm all XML files stored in Odoo filestore
   - Test XML retrieval (can you download original?)
   - Verify XML files are backed up separately (legal compliance)

5. **User Access Test**
   - Can users search and view historical invoices?
   - Can they download original XML?
   - Can they regenerate PDF (if applicable)?

**Timeline**: 2-3 days for thorough validation

---

### PHASE 4: New Invoice Operations (January 2025+)

**First New Invoice Test**:

1. Create invoice in Odoo for January 2025
2. Verify consecutive number: 00000001235 (continues from old system)
3. Submit to Hacienda for validation
4. Receive acceptance message
5. Send PDF + XML to customer

**Critical Success Factors**:
- ✓ Consecutive numbering continued correctly
- ✓ New cryptographic key working
- ✓ Hacienda accepts invoice (not rejected)
- ✓ Customer receives valid invoice

**If Successful**: Migration complete! Historical data preserved, new invoices flowing.

---

## Section 5: Implementation Recommendation for Odoo

### What We Should Build

Based on research findings and technical feasibility, here's the recommended approach:

---

### TIER 1: MVP - CSV Import (6-day sprint)

**Deliverable**: Basic historical invoice import via CSV

**Features**:
1. **CSV Upload Interface**
   - Web form: Upload `.csv` file
   - Template download: Provide sample CSV with correct headers
   - Column mapping: Auto-detect or manual map

2. **Data Validation**
   - Check required fields (date, number, customer, amount)
   - Validate date format
   - Verify customer exists (or create new)
   - Validate consecutive number format

3. **Import Process**
   - Create `account.move` records with `state='posted'`
   - Flag as historical: `l10n_cr_historical = True`
   - Skip Hacienda submission: `skip_hacienda_validation = True`
   - Generate simple invoice lines

4. **Import Report**
   - Show: X invoices imported successfully
   - List: Failed imports with error messages
   - Allow: Export error log for fixing

**Technical Implementation**:

```python
# File: l10n_cr_invoice/models/account_move.py

class AccountMove(models.Model):
    _inherit = 'account.move'

    l10n_cr_historical = fields.Boolean(
        string='Historical Invoice',
        help='Invoice imported from previous system, not submitted to Hacienda'
    )

    l10n_cr_clave = fields.Char(
        string='Hacienda Clave',
        size=50,
        help='50-digit access key from Hacienda'
    )

# File: l10n_cr_invoice/wizard/import_historical_invoices.py

class ImportHistoricalInvoices(models.TransientModel):
    _name = 'l10n_cr.import.historical.invoices'

    csv_file = fields.Binary(string='CSV File', required=True)
    filename = fields.Char()

    def action_import(self):
        # Decode CSV
        csv_data = base64.b64decode(self.csv_file)
        csv_reader = csv.DictReader(io.StringIO(csv_data.decode('utf-8')))

        success_count = 0
        error_log = []

        for row in csv_reader:
            try:
                # Parse row
                invoice_vals = {
                    'type': 'out_invoice',
                    'state': 'posted',
                    'invoice_date': row['Fecha'],
                    'name': row['Numero'],
                    'partner_id': self._get_partner(row['Cliente_NIF']),
                    'l10n_cr_historical': True,
                    'l10n_cr_clave': row.get('Clave_Hacienda', ''),
                    'invoice_line_ids': [(0, 0, {
                        'name': row['Concepto'],
                        'price_unit': float(row['Total']),
                        'quantity': 1,
                    })]
                }

                # Create invoice without validation
                self.env['account.move'].with_context(
                    skip_hacienda_validation=True
                ).create(invoice_vals)

                success_count += 1

            except Exception as e:
                error_log.append(f"Row {csv_reader.line_num}: {str(e)}")

        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': 'Import Complete',
                'message': f'{success_count} invoices imported. {len(error_log)} errors.',
                'sticky': True,
            }
        }
```

**User Experience**:
1. Navigate to: `Accounting > Configuration > Import Historical Invoices`
2. Download CSV template
3. Fill template with data from old system
4. Upload CSV
5. Click "Import"
6. View results

**Effort Estimate**:
- Backend: 2 days (CSV parsing, validation, import logic)
- Frontend: 1 day (wizard UI)
- Testing: 1 day
- Documentation: 0.5 days
- **Total: 4.5 days**

**Pros**:
- Simple to implement
- Works with any old system (universal format)
- Fast import processing
- Minimal dependencies

**Cons**:
- No XML preservation (must store separately)
- Simplified invoice structure
- Manual CSV preparation required

---

### TIER 2: Enhanced - XML Import (12-day sprint)

**Deliverable**: Full XML import with archival

**Additional Features** (beyond CSV import):

1. **ZIP Upload**
   - Accept `.zip` file containing multiple XMLs
   - Extract and process each XML file

2. **XML Parsing**
   - Parse Costa Rica e-invoice XML v4.4 schema
   - Extract all invoice fields (header, lines, taxes, totals)
   - Preserve digital signature information

3. **XML Storage**
   - Store original XML in Odoo attachment system
   - Link XML to invoice record
   - Enable XML download from invoice view

4. **PDF Generation**
   - Generate PDF from XML data using QWeb template
   - Replicate old invoice layout (or use standard template)
   - Store PDF alongside XML

5. **Advanced Validation**
   - Verify XML structure against XSD schema
   - Check clave (access key) format
   - Validate digital signature (optional)

**Technical Implementation**:

```python
# File: l10n_cr_invoice/models/account_move.py

class AccountMove(models.Model):
    _inherit = 'account.move'

    l10n_cr_xml_original = fields.Binary(
        string='Original XML',
        attachment=True,
        help='Original XML file from previous provider'
    )

    l10n_cr_xml_filename = fields.Char()

    def action_download_xml(self):
        """Allow users to download original XML"""
        return {
            'type': 'ir.actions.act_url',
            'url': f'/web/content?model=account.move&id={self.id}&field=l10n_cr_xml_original&filename={self.l10n_cr_xml_filename}',
            'target': 'new',
        }

# File: l10n_cr_invoice/wizard/import_historical_xml.py

class ImportHistoricalXML(models.TransientModel):
    _name = 'l10n_cr.import.historical.xml'

    zip_file = fields.Binary(string='ZIP File (XMLs)', required=True)

    def action_import(self):
        # Extract ZIP
        zip_data = base64.b64decode(self.zip_file)
        zip_file = zipfile.ZipFile(io.BytesIO(zip_data))

        for xml_filename in zip_file.namelist():
            if not xml_filename.endswith('.xml'):
                continue

            # Read XML
            xml_content = zip_file.read(xml_filename)
            xml_tree = etree.fromstring(xml_content)

            # Parse XML (v4.4 schema)
            invoice_data = self._parse_cr_invoice_xml(xml_tree)

            # Create invoice
            invoice = self.env['account.move'].with_context(
                skip_hacienda_validation=True
            ).create(invoice_data)

            # Attach original XML
            self.env['ir.attachment'].create({
                'name': xml_filename,
                'datas': base64.b64encode(xml_content),
                'res_model': 'account.move',
                'res_id': invoice.id,
                'type': 'binary',
            })

            # Generate PDF
            pdf_content = self.env['ir.actions.report']._render_qweb_pdf(
                'l10n_cr_invoice.report_invoice_cr', invoice.ids
            )[0]

            self.env['ir.attachment'].create({
                'name': f'{xml_filename}.pdf',
                'datas': base64.b64encode(pdf_content),
                'res_model': 'account.move',
                'res_id': invoice.id,
                'type': 'binary',
            })

    def _parse_cr_invoice_xml(self, xml_tree):
        """Parse Costa Rica e-invoice XML structure"""
        ns = {'fe': 'https://cdn.comprobanteselectronicos.go.cr/xml-schemas/v4.4/facturaElectronica'}

        # Extract fields
        clave = xml_tree.find('fe:Clave', ns).text
        consecutive = xml_tree.find('fe:NumeroConsecutivo', ns).text
        date = xml_tree.find('fe:FechaEmision', ns).text[:10]

        receptor = xml_tree.find('fe:Receptor', ns)
        partner_vat = receptor.find('fe:Identificacion/fe:Numero', ns).text
        partner = self.env['res.partner'].search([('vat', '=', partner_vat)], limit=1)

        lines = []
        for linea in xml_tree.findall('fe:DetalleServicio/fe:LineaDetalle', ns):
            lines.append((0, 0, {
                'name': linea.find('fe:Descripcion', ns).text,
                'quantity': float(linea.find('fe:Cantidad', ns).text),
                'price_unit': float(linea.find('fe:PrecioUnitario', ns).text),
            }))

        return {
            'type': 'out_invoice',
            'state': 'posted',
            'invoice_date': date,
            'name': consecutive,
            'partner_id': partner.id,
            'l10n_cr_clave': clave,
            'l10n_cr_historical': True,
            'invoice_line_ids': lines,
        }
```

**Effort Estimate**:
- XML parsing: 3 days (schema analysis, parsing logic)
- ZIP handling: 1 day
- Attachment management: 1 day
- PDF generation: 2 days (template design)
- Testing: 2 days
- Documentation: 1 day
- **Total: 10 days**

**Pros**:
- Complete data preservation
- Legal compliance (5-year XML retention)
- Can regenerate PDFs
- Professional solution

**Cons**:
- Complex implementation
- Requires understanding of XML schema
- Larger storage requirements

---

### TIER 3: Premium - Direct Provider Integration (30+ days)

**Deliverable**: API integration with major providers

**Features**:
- OAuth authentication with FACTURATica/GTI/etc.
- Direct data pull from provider API
- Real-time sync option
- Automated migration wizard

**Recommendation**: NOT WORTH IT
- Too complex for 6-day sprint model
- Provider APIs may not be available/documented
- Competitive providers unlikely to cooperate
- CSV/XML import covers 95% of use cases

---

### RECOMMENDED APPROACH: TIER 1 (CSV) First, TIER 2 (XML) Later

**Phase 1 (Month 1)**: Build CSV import
- Covers immediate need
- Quick to market
- Works for all customers

**Phase 2 (Month 3)**: Add XML import
- After validating CSV import works well
- Based on customer demand
- Provides competitive advantage

**XML Storage Workaround** (until Tier 2 built):
- Customers can manually upload XML files as attachments
- Use Odoo's built-in document management
- Navigate to invoice → Attach files → Upload XMLs
- Not automated but satisfies legal requirement

---

## Section 6: Key Questions Answered

### Q1: Are historical invoices re-submitted to Hacienda?

**Answer: NO**

- Historical invoices were already validated by Hacienda when originally issued
- They have permanent clave (access key) and digital signature
- Re-submitting would create duplicates and cause confusion
- New provider only imports for reporting/archival purposes

**Source**: Industry practice and legal logic (no explicit regulation found)

---

### Q2: What file format do customers provide?

**Answer: It varies by provider**

**Most Common**: CSV/Excel export (metadata only)
- Simple, universal format
- Loses XML and digital signature
- Good enough for reporting

**Best Practice**: Original XML files in ZIP archive
- FACTURATica demonstrated this capability (100M+ invoices)
- Preserves complete data and legal compliance
- Requires more sophisticated import capability

**Least Common**: API/database integration
- Only for enterprise customers
- Requires custom development

---

### Q3: How long does import take?

**Answer: Depends on method and volume**

**CSV Import**:
- 1,200 invoices: 5-10 minutes
- Odoo can process ~150-200 records per minute

**XML Import**:
- 1,200 invoices: 20-30 minutes (including PDF generation)
- More complex parsing but still fast

**FACTURATica Example**:
- 100 million invoices in "a matter of hours"
- Implies ~5-10 million invoices per hour
- Highly optimized batch processing

**Conclusion**: 1,200 invoices is a small dataset, should process in under 1 hour regardless of method

---

### Q4: What data is required vs. optional?

**Minimum Viable Import** (CSV approach):

**Required**:
- Invoice date
- Invoice consecutive number
- Customer tax ID (or name for matching)
- Total amount
- Currency

**Highly Recommended**:
- Hacienda clave (50-digit access key)
- Subtotal (before tax)
- Tax amount
- Payment status

**Optional (nice to have)**:
- Line item details
- Payment method
- Due date
- Notes

**Full Import** (XML approach):
- All fields from original XML
- Digital signature
- Hacienda validation response

---

### Q5: Do old invoices need to be in new system for tax declarations?

**Answer: TECHNICALLY NO, but PRACTICALLY YES**

**Legal Requirement**:
- Must store XML files for 5 years
- Can be in separate archive (not in new provider)

**Practical Reality**:
- Tax declarations (D104 form) need all invoice data
- Easier to generate reports if all data in one system
- Manual reconciliation is error-prone

**Best Practice**: Import historical invoices into new system for:
- Unified reporting
- Customer account history
- Revenue analytics
- Tax preparation

**Alternative**: Keep old system read-only access for 5 years (expensive, inconvenient)

---

### Q6: Can customers re-download original XML?

**Answer: Depends on implementation**

**If XML imported and stored** (Tier 2 approach):
- Yes, can download original XML from invoice view
- Satisfies legal compliance

**If CSV imported** (Tier 1 approach):
- No, CSV doesn't contain XML
- Customer must store XML separately (e.g., external hard drive, cloud storage)
- Can upload XML as attachment manually

**Recommendation**: Provide XML storage capability, even if CSV import initially

---

### Q7: What happens if data is malformed?

**Answer: Validation and error handling required**

**Import Validation**:
1. File format check (valid CSV/XML/ZIP)
2. Required field check (all mandatory fields present)
3. Data type validation (dates are dates, numbers are numbers)
4. Customer matching (VAT exists in system)
5. Duplicate detection (invoice number not already used)

**Error Handling Options**:

**Option A: Skip and Log**
- Skip failed records
- Continue importing valid records
- Show error log at end
- User fixes errors and re-imports failed records

**Option B: Stop on Error**
- Abort entire import if any record fails
- User fixes errors and re-imports all
- More conservative but slower

**Recommendation**: Option A (skip and log) - better user experience

---

## Section 7: Final Recommendations

### For Odoo GMS Project

#### PRIORITY 1: Build CSV Import (MVP)

**Timeline**: 4-5 days

**Justification**:
- Covers most use cases (90%+ of customers)
- Fast to implement and validate
- Works with any old provider
- Enables customer migration immediately

**Implementation**:
- CSV upload wizard
- Template download
- Validation and error handling
- Import report

**Acceptance Criteria**:
- Can import 1,200 invoices in <10 minutes
- Validates all required fields
- Shows clear error messages
- Creates searchable invoice records

---

#### PRIORITY 2: Add XML Attachment Support (Stopgap)

**Timeline**: 1 day

**Justification**:
- Satisfies legal 5-year retention requirement
- No complex XML parsing needed yet
- Customer manually uploads XML files

**Implementation**:
- Enable attachments on historical invoices
- Add button: "Upload Historical XMLs"
- User uploads ZIP or individual XMLs
- System links to invoice records

**Acceptance Criteria**:
- Customers can attach XML files to invoices
- Can download attached XML files
- Searchable/filterable in document manager

---

#### PRIORITY 3: Build XML Import (Full Solution)

**Timeline**: 10-12 days (future sprint)

**Justification**:
- Competitive differentiator
- Professional solution
- Future-proof for growth

**Implementation**:
- ZIP upload wizard
- XML v4.4 schema parser
- Automatic invoice creation from XML
- PDF regeneration
- Complete data preservation

**Acceptance Criteria**:
- Can parse Costa Rica e-invoice XML v4.4
- Creates complete invoice records (header + lines)
- Stores original XML as attachment
- Generates viewable PDF

---

### For Gym Owners (End Users)

#### When Migrating to Odoo:

**Step 1**: Request XML files from old provider (1 week before migration)

**Step 2**: Export invoice list to CSV (backup method)

**Step 3**: During migration:
- Import CSV for reporting capability
- Upload XML files as attachments for compliance

**Step 4**: Verify data integrity:
- Spot-check 10-20 invoices
- Verify totals match old system
- Test tax report generation

**Step 5**: Start using Odoo for new invoices (January 1)

**Step 6**: Keep old system accessible for 30 days (just in case)

---

### Industry Trends to Monitor

1. **Version 4.4 Compliance** (mandatory Sept 1, 2025)
   - All providers must support new XML structure
   - Migration opportunity for customers on old versions

2. **Provider Consolidation**
   - FACTURATica gained 130,000+ licenses (market leader)
   - Smaller providers may exit market
   - More migration opportunities

3. **API Standardization**
   - PROCOM demonstrates value of documented APIs
   - Trend toward integration vs. standalone systems
   - Odoo's API advantage

4. **Storage and Compliance**
   - 5-year retention creates data management burden
   - Cloud storage solutions emerging
   - Opportunity for value-added services

---

## Appendices

### Appendix A: CSV Template Example

**File**: `invoice_import_template.csv`

```csv
Fecha,Serie,Numero,Cliente_NIF,Cliente_Nombre,Concepto,Base_Imponible,IVA_Tipo,IVA_Cuota,Total,Moneda,Clave_Hacienda
2024-01-01,001,00000001234,103450678,Juan Pérez,Membresía Mensual,50000.00,13,6500.00,56500.00,CRC,50601012024010100123456789012345678901234567890
2024-01-02,001,00000001235,205670123,María López,Membresía Anual,480000.00,13,62400.00,542400.00,CRC,50601012024010200123456789012345678901234567891
```

**Field Descriptions**:
- `Fecha`: YYYY-MM-DD format
- `Serie`: Invoice series (e.g., 001, 002)
- `Numero`: 10-digit consecutive number
- `Cliente_NIF`: Tax ID (cédula física, cédula jurídica, DIMEX, etc.)
- `Cliente_Nombre`: Customer full name
- `Concepto`: Invoice description/concept
- `Base_Imponible`: Subtotal before tax (colones)
- `IVA_Tipo`: Tax percentage (13 for standard rate)
- `IVA_Cuota`: Tax amount (colones)
- `Total`: Total including tax (colones)
- `Moneda`: ISO 4217 currency code (CRC for Costa Rica)
- `Clave_Hacienda`: 50-digit Hacienda access key (optional but recommended)

---

### Appendix B: XML Schema Reference

**Costa Rica E-Invoice v4.4 Key Elements**:

```xml
<FacturaElectronica>
  <Clave>50-digit access key</Clave>
  <NumeroConsecutivo>20-character consecutive</NumeroConsecutivo>
  <FechaEmision>ISO 8601 datetime</FechaEmision>

  <Emisor>
    <Nombre>Company Name</Nombre>
    <Identificacion>
      <Tipo>02</Tipo> <!-- 01=Física, 02=Jurídica, 03=DIMEX, 04=NITE -->
      <Numero>Tax ID</Numero>
    </Identificacion>
    <!-- Address, phone, email, etc. -->
  </Emisor>

  <Receptor>
    <Nombre>Customer Name</Nombre>
    <Identificacion>
      <Tipo>01</Tipo>
      <Numero>Customer Tax ID</Numero>
    </Identificacion>
    <!-- Address, phone, email, etc. -->
  </Receptor>

  <DetalleServicio>
    <LineaDetalle>
      <NumeroLinea>1</NumeroLinea>
      <Descripcion>Product/Service Description</Descripcion>
      <Cantidad>Quantity</Cantidad>
      <UnidadMedida>Unit</UnidadMedida>
      <PrecioUnitario>Unit Price</PrecioUnitario>
      <MontoTotal>Line Total</MontoTotal>
      <Impuesto>
        <Codigo>01</Codigo> <!-- 01=IVA, 02=Consumo, etc. -->
        <Tarifa>13.00</Tarifa>
        <Monto>Tax Amount</Monto>
      </Impuesto>
    </LineaDetalle>
  </DetalleServicio>

  <ResumenFactura>
    <TotalVenta>Subtotal</TotalVenta>
    <TotalImpuesto>Total Tax</TotalImpuesto>
    <TotalComprobante>Grand Total</TotalComprobante>
  </ResumenFactura>

  <!-- Digital Signature -->
</FacturaElectronica>
```

**XSD Schema**: https://www.hacienda.go.cr/docs/schemas/v4.4/FacturaElectronica_V4.4.xsd

---

### Appendix C: Useful Resources

**Official Hacienda Resources**:
- ATV Portal: https://atv.hacienda.go.cr/
- E-invoice Regulations: https://www.hacienda.go.cr/docs/DGT-R-000-2024DisposicionesTecnicasDeComprobantesElectronicosCP.pdf
- XML Schemas v4.4: https://www.hacienda.go.cr/docs/schemas/

**Provider Documentation**:
- FACTURATica: https://facturatica.com/ (limited public docs)
- GTI Facturación: https://www.gticr.com/
- TicoPay Blog: https://blog.ticopays.com/
- PROCOM: https://www.procom.cr/

**Technical Guides**:
- Fonoa CR E-invoice Guide: https://www.fonoa.com/resources/blog/practical-guide-to-e-invoicing-in-costa-rica
- EDICOM CR Guide: https://edicomgroup.com/blog/how-electronic-invoicing-works-in-costa-rica
- Microsoft Dynamics Guide: https://learn.microsoft.com/en-us/dynamics365/finance/localizations/iberoamerica/ltm-costa-rica-ei-connec-configuration

**Community Resources**:
- Odoo CR GitHub: https://github.com/odoocr/l10n_cr
- CRLibre E-invoice Module: https://github.com/CRLibre/fe-hacienda-cr-odoo

---

## Conclusion

### The Bottom Line

**Historical invoice import in Costa Rica e-invoicing is:**

1. **Possible**: Proven by FACTURATica (100M+ invoices imported)
2. **Necessary**: For reporting, compliance, and customer satisfaction
3. **Not standardized**: Each provider has their own approach
4. **Two paths**: Simple (CSV metadata) or Complete (XML with archival)
5. **Not Hacienda-involved**: Historical invoices are NOT re-submitted

### For Odoo Implementation

**Build CSV import first** (4-5 days):
- Satisfies 90% of customer needs
- Fast time-to-market
- Low complexity, high value

**Add XML import later** (10-12 days):
- Differentiates from competitors
- Provides complete solution
- Justifies premium pricing

**Competitive Advantage**:
- Most providers don't advertise import capabilities clearly
- FACTURATica leads but doesn't share technical details
- Odoo's open-source transparency + import capability = winning combo

### Market Opportunity

**Timing**: Perfect
- Version 4.4 mandatory (Sept 2025) = migration wave
- SMBs looking for affordable alternatives to enterprise providers
- Gym owners need simple, integrated solutions

**Positioning**: "Migrate to Odoo with confidence - we preserve your entire invoice history"

**Value Proposition**:
- 5-year compliance guaranteed (XML storage)
- Unified reporting (old + new invoices)
- No data loss during migration
- Open-source flexibility

---

**End of Research Report**

---

## Sources

All sources used in this research:

- [What to consider when changing e-invoicing providers](https://blog.factun.com/facturacion-electronica/lo-que-debes-tomar-en-cuenta-al-cambiar-de-proveedor-de-factura-electronica)
- [FACTURATica imports 100M+ electronic invoices](https://ticosland.com/facturatica-imports-over-100-million-electronic-invoices-from-recently-migrated-customers/)
- [FACTURATica remains preferred platform with import capabilities](https://ticosland.com/facturatica-remains-the-preferred-electronic-invoicing-platform-in-costa-rica-with-the-addition-of-its-import-capabilities/)
- [GTI Facturacion analysis](https://programascontabilidad.com/analisis-de-herramientas/gti-facturacion-costa-rica/)
- [TicoPay batch XML confirmation](https://blog.ticopays.com/2019/03/13/confirmacion-de-xml-por-lote-nueva-funcionalidad-de-ticopay/)
- [PROCOM best e-invoicing provider 4.4](https://www.procom.cr/cual-es-el-mejor-proveedor-de-facturacion-electronica-4-4-en-costa-rica/)
- [FacturaDirecta CSV import format](https://help.facturadirecta.com/es/articles/1070807-importar-facturas-y-gastos-en-excel-o-csv)
- [FacturaDirecta invoice import format](https://www.facturadirecta.com/clasico/formato-de-importacion-de-facturas/)
- [Practical guide to e-invoicing in Costa Rica](https://www.fonoa.com/resources/blog/practical-guide-to-e-invoicing-in-costa-rica)
- [Electronic invoicing in Costa Rica (EDICOM)](https://edicomgroup.com/blog/how-electronic-invoicing-works-in-costa-rica)
- [Hacienda electronic invoice regulations v4.4](https://www.hacienda.go.cr/docs/ComprobantesElectronicos-GeneralidadesyVersion4.4.marzo2025.pdf)
- [Costa Rica 5-year storage requirements](https://edicom.co/blog/como-es-la-factura-electronica-en-costa-rica)
- [Abaq CSV invoice bulk upload](https://help.abaq.app/es/articles/8790189-carga-de-facturas-en-lote-con-un-archivo-csv)
- [QuickBooks batch invoicing](https://quickbooks.intuit.com/online/advanced/expenses-transactions/)
- [Invoice processing automation times](https://www.getyooz.com/automated-invoice-processing)
- [Odoo CR e-invoice module](https://apps.odoo.com/apps/modules/17.0/l10n_cr_invoice)
- [Microsoft Dynamics CR e-invoice configuration](https://learn.microsoft.com/en-us/dynamics365/finance/localizations/iberoamerica/ltm-costa-rica-ei-connec-configuration)
